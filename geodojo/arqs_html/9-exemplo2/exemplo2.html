

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Exemplo2 - Construindo um visualizador de consultas espaciais &mdash; GeoDOJO vGeoDOJO documentation</title>
    <link rel="stylesheet" href="../_static/geotools-tutorial.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     'GeoDOJO',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="GeoDOJO vGeoDOJO documentation" href="../index.html" />
    <link rel="next" title="Exemplo 3" href="../10-exemplo3/exemplo3.html" />
    <link rel="prev" title="Exemplo1 - Enviando um geotwitt" href="../8-exemplo1/exemplo1.html" /> 
  </head>
  <body>
    <div class="header">
        <div class="wrap">
            <ul id="top-nav">
                <li><a href="http://www.latinoware.org/">Latinoware 2010</a></li>
            </ul>
        </div>
    </div>

    <div class="related">
      <ul id="breadcrumbs">
            <li class="right" style="margin-right: 10px">
              <a href="../genindex.html" title="General Index"
                 accesskey="I">index</a></li>
            <li class="right" >
              <a href="../10-exemplo3/exemplo3.html" title="Exemplo 3"
                 accesskey="N">next</a> |</li>
            <li class="right" >
              <a href="../8-exemplo1/exemplo1.html" title="Exemplo1 - Enviando um geotwitt"
                 accesskey="P">previous</a> |</li>
        <li><a href="../index.html">GeoDOJO vGeoDOJO documentation</a> &raquo;</li>
        <li><a href="#">Exemplo2 - Construindo um visualizador de consultas espaciais</a></li>
      </ul>
    </div>


    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="exemplo2-construindo-um-visualizador-de-consultas-espaciais">
<h1><a class="toc-backref" href="#id1">Exemplo2 - Construindo um visualizador de consultas espaciais</a><a class="headerlink" href="#exemplo2-construindo-um-visualizador-de-consultas-espaciais" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#exemplo2-construindo-um-visualizador-de-consultas-espaciais" id="id1">Exemplo2 - Construindo um visualizador de consultas espaciais</a></li>
</ul>
</div>
<p>Que tal utilizarmos o conhecimento adquirido e desenvolvermos um visualizador de consultas espaciais?</p>
<p>Não pense que vai ficar algo muito bonito, estamos nos concentrando na funcionalidade. Pra deixar bonito teríamos que pedir o auxílio para outras bibliotecas JSF ou até mesmo manipular CSS manualmente. Mas esse não é nosso caso, aqui faremos &#8220;interfaces de macho&#8221; (péssima expressão, mas tudo bem, vamos adiante)! :D</p>
<p>Vamos fazer aos poucos, passa a passo, seguindo a filosofia do <em>baby steps</em>.</p>
<ol class="arabic simple">
<li>Criar arquivo queryView.xhtml no diretório <em>geodojo/src/main/webapp</em>;</li>
<li>Para o exercício ficar mais interessante, vamos exibir o mapa de divisão politica do brasil que criamos no capítulo do geoserver. Segue o código:</li>
</ol>
<div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</span>
<span class="nt">&lt;html</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span>
        <span class="na">xmlns:h=</span><span class="s">&quot;http://java.sun.com/jsf/html&quot;</span>
        <span class="na">xmlns:f=</span><span class="s">&quot;http://java.sun.com/jsf/core&quot;</span>
        <span class="na">xmlns:ui=</span><span class="s">&quot;http://java.sun.com/jsf/facelets&quot;</span>
        <span class="na">xmlns:m=</span><span class="s">&quot;http://www.ol4jsf.org&quot;</span><span class="nt">&gt;</span>

<span class="nt">&lt;h:head&gt;</span>
<span class="nt">&lt;/h:head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;h1&gt;</span>Query View<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;h:form</span> <span class="na">prependId=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h:panelGroup</span> <span class="na">id=</span><span class="s">&quot;mapPanel&quot;</span> <span class="na">layout=</span><span class="s">&quot;block&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;m:map</span> <span class="na">width=</span><span class="s">&quot;512px&quot;</span> <span class="na">height=</span><span class="s">&quot;480px&quot;</span>
                <span class="na">options=</span><span class="s">&quot;{controls: [],</span>
<span class="s">                                        maxExtent: new OpenLayers.Bounds(</span>
<span class="s">                                        -73.991, -33.751,</span>
<span class="s">                                        -32.378, 5.272</span>
<span class="s">                                        ),</span>
<span class="s">                                        maxResolution: 0.16255078125</span>
<span class="s">                                        }&quot;</span> <span class="na">renderOnWindowLoad=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;m:wmsLayer</span> <span class="na">name=</span><span class="s">&quot;OpenLayers WMS&quot;</span>
                                <span class="na">url=</span><span class="s">&quot;#{facesContext.externalContext.requestContextPath}/OL4JSFProxy/wms&quot;</span>
                                <span class="na">params=</span><span class="s">&quot;{layers:&#39;limite_politico&#39;}&quot;</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:featureInfoPopup</span>
                                <span class="na">url=</span><span class="s">&quot;#{facesContext.externalContext.requestContextPath}/OL4JSFProxy/wms&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;/m:featureInfoPopup&gt;</span>
                        <span class="nt">&lt;m:navigationControl</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:panZoomBarControl</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:layerSwitcherControl</span> <span class="na">options=</span><span class="s">&quot;{ascending:false}&quot;</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:scaleLineControl</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:mousePositionControl</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:overviewMapControl</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:permalinkControl</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/m:map&gt;</span>
        <span class="nt">&lt;/h:panelGroup&gt;</span>
<span class="nt">&lt;/h:form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</td></tr></table></div>
<p>Ok! Nada de muito diferente até agora. Lembra quando falamos que o OL4JSF não engessa o desenvolvimento? Veja que utilizamos a API diretamente nas opções do nosso mapa. Colocamos também o nosso mapa dentro de um panelGroup para fazer algumas coisas legais mais adiante.</p>
<a class="reference internal image-reference" href="../_images/ol4jsf_8.png"><img alt="../_images/ol4jsf_8.png" src="../_images/ol4jsf_8.png" style="width: 505.2px; height: 324.0px;" /></a>
<ol class="arabic simple" start="3">
<li>Agora vamos esquentar. Vamos adicionar uma camada vetorial cujo valor virá de um bean e, agora sim, as geometrias serão retornadas a partir de um SQL feito a partir de um textarea. Vamos alterar o nosso arquivo queryView.xhtml para ficar com o seguinte código:</li>
</ol>
<div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</span>
<span class="nt">&lt;html</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span>
        <span class="na">xmlns:h=</span><span class="s">&quot;http://java.sun.com/jsf/html&quot;</span>
        <span class="na">xmlns:f=</span><span class="s">&quot;http://java.sun.com/jsf/core&quot;</span>
        <span class="na">xmlns:ui=</span><span class="s">&quot;http://java.sun.com/jsf/facelets&quot;</span>
        <span class="na">xmlns:m=</span><span class="s">&quot;http://www.ol4jsf.org&quot;</span><span class="nt">&gt;</span>

<span class="nt">&lt;h:head&gt;</span>
<span class="nt">&lt;/h:head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;h1&gt;</span>Query View<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;h:form</span> <span class="na">prependId=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h:panelGroup</span> <span class="na">id=</span><span class="s">&quot;mapPanel&quot;</span> <span class="na">layout=</span><span class="s">&quot;block&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;m:map</span> <span class="na">width=</span><span class="s">&quot;512px&quot;</span> <span class="na">height=</span><span class="s">&quot;480px&quot;</span>
                <span class="na">options=</span><span class="s">&quot;{controls: [],</span>
<span class="s">                                        maxExtent: new OpenLayers.Bounds(</span>
<span class="s">                                        -73.991, -33.751,</span>
<span class="s">                                        -32.378, 5.272</span>
<span class="s">                                        ),</span>
<span class="s">                                        maxResolution: 0.16255078125</span>
<span class="s">                                        }&quot;</span> <span class="na">renderOnWindowLoad=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;m:wmsLayer</span> <span class="na">name=</span><span class="s">&quot;OpenLayers WMS&quot;</span>
                                <span class="na">url=</span><span class="s">&quot;#{facesContext.externalContext.requestContextPath}/OL4JSFProxy/wms&quot;</span>
                                <span class="na">params=</span><span class="s">&quot;{layers:&#39;limite_politico&#39;}&quot;</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:vectorLayer</span> <span class="na">name=</span><span class="s">&quot;Query Result&quot;</span> <span class="na">value=</span><span class="s">&quot;#{queryViewManager.wkts}&quot;</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:featureInfoPopup</span>
                                <span class="na">url=</span><span class="s">&quot;#{facesContext.externalContext.requestContextPath}/OL4JSFProxy/wms&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;/m:featureInfoPopup&gt;</span>
                        <span class="nt">&lt;m:navigationControl</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:panZoomBarControl</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:layerSwitcherControl</span> <span class="na">options=</span><span class="s">&quot;{ascending:false}&quot;</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:scaleLineControl</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:mousePositionControl</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:overviewMapControl</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:permalinkControl</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/m:map&gt;</span>
        <span class="nt">&lt;/h:panelGroup&gt;</span>
        <span class="nt">&lt;h:messages</span> <span class="na">id=</span><span class="s">&quot;msg&quot;</span> <span class="na">globalOnly=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;/h:messages&gt;</span>
        <span class="nt">&lt;fieldset&gt;&lt;legend&gt;</span>Consultas espaciais<span class="nt">&lt;/legend&gt;</span>
        <span class="nt">&lt;h:inputTextarea</span> <span class="na">id=</span><span class="s">&quot;inputQuery&quot;</span> <span class="na">value=</span><span class="s">&quot;#{queryViewManager.query}&quot;</span> <span class="na">cols=</span><span class="s">&quot;60&quot;</span> <span class="na">rows=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;/h:inputTextarea&gt;</span>
        <span class="nt">&lt;p&gt;&lt;h:commandButton</span> <span class="na">value=</span><span class="s">&quot;Executar Consulta&quot;</span>
                <span class="na">action=</span><span class="s">&quot;#{queryViewManager.executeQuery}&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;/h:commandButton&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;/fieldset&gt;</span>
<span class="nt">&lt;/h:form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</td></tr></table></div>
<ol class="arabic simple" start="4">
<li>Hora de criar o bean! Crie a classe java <em>org.latinoware.geodojo.app.bean.QueryViewManager.java</em> com o seguinte código:</li>
</ol>
<div class="highlight-java"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">latinoware</span><span class="o">.</span><span class="na">geodojo</span><span class="o">.</span><span class="na">beans</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.enterprise.inject.Model</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.faces.application.FacesMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.faces.context.FacesContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.EntityManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Query</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.ol4jsf.util.WKTFeaturesCollection</span><span class="o">;</span>

<span class="nd">@Model</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">QueryViewManager</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">EntityManager</span> <span class="n">em</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">query</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getQuery</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setQuery</span><span class="o">(</span><span class="n">String</span> <span class="n">query</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">wkts</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getWkts</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">wkts</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setWkts</span><span class="o">(</span><span class="n">String</span> <span class="n">wkts</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">wkts</span> <span class="o">=</span> <span class="n">wkts</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unchecked&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">executeQuery</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">WKTFeaturesCollection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">wktFeatures</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WKTFeaturesCollection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
            <span class="n">Query</span> <span class="n">q</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createNativeQuery</span><span class="o">(</span><span class="n">query</span><span class="o">);</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;)</span> <span class="n">q</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
            <span class="n">wktFeatures</span><span class="o">.</span><span class="na">addAllFeatures</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
            <span class="n">setWkts</span><span class="o">(</span><span class="n">wktFeatures</span><span class="o">.</span><span class="na">toMap</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">FacesContext</span><span class="o">.</span><span class="na">getCurrentInstance</span><span class="o">().</span><span class="na">addMessage</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">FacesMessage</span><span class="o">(</span><span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p>Viram alguma coisa demais? Aposto que não! O componente textarea vai setar o atributo query, o commandbutton vai executar o método executeQuery e retornar um conjunto de <em>features</em> que serão exibidas pela vectorLayer.</p>
<p>Nossa tela deve estar mais ou menos assim:</p>
<a class="reference internal image-reference" href="../_images/ol4jsf_9.png"><img alt="../_images/ol4jsf_9.png" src="../_images/ol4jsf_9.png" style="width: 327.0px; height: 507.6px;" /></a>
<p>Vamos executar a consulta abaixo e visualizar o resultado:</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">select</span> <span class="n">st_astext</span><span class="p">(</span><span class="n">the_geom</span><span class="p">)</span> <span class="k">from</span> <span class="n">municipio</span> <span class="k">where</span> <span class="n">nome</span><span class="o">=</span><span class="s1">&#39;ALTAMIRA&#39;</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/ol4jsf_10.png"><img alt="../_images/ol4jsf_10.png" src="../_images/ol4jsf_10.png" style="width: 322.2px; height: 473.4px;" /></a>
<p>O céu é o limite! Podemos fazer agora qualquer consulta espacial e exibir as geometrias retornadas. Vamos executar uma das consultas do capítulo sobre Postgis. Vamos exibir os 10 maiores municípios do país em área:</p>
<div class="highlight-sql"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">SELECT</span>
  <span class="n">st_astext</span><span class="p">(</span><span class="n">municipio</span><span class="p">.</span><span class="n">the_geom</span><span class="p">)</span>
<span class="k">FROM</span>
  <span class="k">public</span><span class="p">.</span><span class="n">municipio</span>
<span class="k">ORDER</span> <span class="k">BY</span>
  <span class="n">ST_AREA</span><span class="p">(</span><span class="n">municipio</span><span class="p">.</span><span class="n">the_geom</span><span class="p">)</span> <span class="k">DESC</span>
<span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<a class="reference internal image-reference" href="../_images/ol4jsf_11.png"><img alt="../_images/ol4jsf_11.png" src="../_images/ol4jsf_11.png" style="width: 324.6px; height: 474.0px;" /></a>
<ol class="arabic simple" start="5">
<li>Nosso visualizador de consultas já está funcionando perfeitamente, mas que tal colocarmos um pouco de ajax na estória? Alterando o arquivo queryView.xhtml...</li>
</ol>
<div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</span>
<span class="nt">&lt;html</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span>
        <span class="na">xmlns:h=</span><span class="s">&quot;http://java.sun.com/jsf/html&quot;</span>
        <span class="na">xmlns:f=</span><span class="s">&quot;http://java.sun.com/jsf/core&quot;</span>
        <span class="na">xmlns:ui=</span><span class="s">&quot;http://java.sun.com/jsf/facelets&quot;</span>
        <span class="na">xmlns:m=</span><span class="s">&quot;http://www.ol4jsf.org&quot;</span><span class="nt">&gt;</span>

<span class="nt">&lt;h:head&gt;</span>
<span class="nt">&lt;/h:head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;h1&gt;</span>Query View<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;h:form</span> <span class="na">prependId=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h:panelGroup</span> <span class="na">id=</span><span class="s">&quot;mapPanel&quot;</span> <span class="na">layout=</span><span class="s">&quot;block&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;m:map</span> <span class="na">width=</span><span class="s">&quot;512px&quot;</span> <span class="na">height=</span><span class="s">&quot;480px&quot;</span>
                <span class="na">options=</span><span class="s">&quot;{controls: [],</span>
<span class="s">                                        maxExtent: new OpenLayers.Bounds(</span>
<span class="s">                                        -73.991, -33.751,</span>
<span class="s">                                        -32.378, 5.272</span>
<span class="s">                                        ),</span>
<span class="s">                                        maxResolution: 0.16255078125</span>
<span class="s">                                        }&quot;</span> <span class="na">renderOnWindowLoad=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;m:wmsLayer</span> <span class="na">name=</span><span class="s">&quot;OpenLayers WMS&quot;</span>
                                <span class="na">url=</span><span class="s">&quot;#{facesContext.externalContext.requestContextPath}/OL4JSFProxy/wms&quot;</span>
                                <span class="na">params=</span><span class="s">&quot;{layers:&#39;limite_politico&#39;}&quot;</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:vectorLayer</span> <span class="na">name=</span><span class="s">&quot;Query Result&quot;</span> <span class="na">value=</span><span class="s">&quot;#{queryViewManager.wkts}&quot;</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:featureInfoPopup</span>
                                <span class="na">url=</span><span class="s">&quot;#{facesContext.externalContext.requestContextPath}/OL4JSFProxy/wms&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;/m:featureInfoPopup&gt;</span>
                        <span class="nt">&lt;m:navigationControl</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:panZoomBarControl</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:layerSwitcherControl</span> <span class="na">options=</span><span class="s">&quot;{ascending:false}&quot;</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:scaleLineControl</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:mousePositionControl</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:overviewMapControl</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:permalinkControl</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/m:map&gt;</span>
        <span class="nt">&lt;/h:panelGroup&gt;</span>
        <span class="nt">&lt;h:messages</span> <span class="na">id=</span><span class="s">&quot;msg&quot;</span> <span class="na">globalOnly=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;/h:messages&gt;</span>
        <span class="nt">&lt;fieldset&gt;&lt;legend&gt;</span>Consultas espaciais<span class="nt">&lt;/legend&gt;</span>
        <span class="nt">&lt;h:inputTextarea</span> <span class="na">id=</span><span class="s">&quot;inputQuery&quot;</span> <span class="na">value=</span><span class="s">&quot;#{queryViewManager.query}&quot;</span> <span class="na">cols=</span><span class="s">&quot;60&quot;</span> <span class="na">rows=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;/h:inputTextarea&gt;</span>
        <span class="nt">&lt;p&gt;&lt;h:commandButton</span> <span class="na">value=</span><span class="s">&quot;Executar Consulta&quot;</span>
                <span class="na">action=</span><span class="s">&quot;#{queryViewManager.executeQuery}&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;f:ajax</span> <span class="na">execute=</span><span class="s">&quot;@this inputQuery qryLanguage&quot;</span> <span class="na">render=</span><span class="s">&quot;mapPanel msg&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/h:commandButton&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;/fieldset&gt;</span>
<span class="nt">&lt;/h:form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</td></tr></table></div>
<p>Visualmente o nosso mapa não mudou nada, mas agora está executando a ação do botão via Ajax. Adicionamos uma única linha:</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;f:ajax</span> <span class="na">execute=</span><span class="s">&quot;@this inputQuery qryLanguage&quot;</span> <span class="na">render=</span><span class="s">&quot;mapPanel msg&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<p>Achou que ajax seria complicado? :)</p>
<ol class="arabic simple" start="6">
<li>Estamos quase acabando. Vamos adicionar suporte a JPQL ao nosso visualizador. Vamos acrescentar um selectOneRadio, onde o usuário poderá escolher entre as opções: Postgis e JPQL. Vejamos a versão final do nosso queryView.xhtml e QueryViewManager.java, respectivamente:</li>
</ol>
<div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</span>
<span class="nt">&lt;html</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span>
        <span class="na">xmlns:h=</span><span class="s">&quot;http://java.sun.com/jsf/html&quot;</span>
        <span class="na">xmlns:f=</span><span class="s">&quot;http://java.sun.com/jsf/core&quot;</span>
        <span class="na">xmlns:ui=</span><span class="s">&quot;http://java.sun.com/jsf/facelets&quot;</span>
        <span class="na">xmlns:m=</span><span class="s">&quot;http://www.ol4jsf.org&quot;</span><span class="nt">&gt;</span>

<span class="nt">&lt;h:head&gt;</span>
<span class="nt">&lt;/h:head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;h1&gt;</span>Query View<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;h:form</span> <span class="na">prependId=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h:panelGroup</span> <span class="na">id=</span><span class="s">&quot;mapPanel&quot;</span> <span class="na">layout=</span><span class="s">&quot;block&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;m:map</span> <span class="na">width=</span><span class="s">&quot;512px&quot;</span> <span class="na">height=</span><span class="s">&quot;480px&quot;</span>
                <span class="na">options=</span><span class="s">&quot;{controls: [],</span>
<span class="s">                                        maxExtent: new OpenLayers.Bounds(</span>
<span class="s">                                        -73.991, -33.751,</span>
<span class="s">                                        -32.378, 5.272</span>
<span class="s">                                        ),</span>
<span class="s">                                        maxResolution: 0.16255078125</span>
<span class="s">                                        }&quot;</span> <span class="na">renderOnWindowLoad=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;m:wmsLayer</span> <span class="na">name=</span><span class="s">&quot;OpenLayers WMS&quot;</span>
                                <span class="na">url=</span><span class="s">&quot;#{facesContext.externalContext.requestContextPath}/OL4JSFProxy/wms&quot;</span>
                                <span class="na">params=</span><span class="s">&quot;{layers:&#39;limite_politico&#39;}&quot;</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:vectorLayer</span> <span class="na">name=</span><span class="s">&quot;Query Result&quot;</span> <span class="na">value=</span><span class="s">&quot;#{queryViewManager.wkts}&quot;</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:featureInfoPopup</span>
                                <span class="na">url=</span><span class="s">&quot;#{facesContext.externalContext.requestContextPath}/OL4JSFProxy/wms&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;/m:featureInfoPopup&gt;</span>
                        <span class="nt">&lt;m:navigationControl</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:panZoomBarControl</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:layerSwitcherControl</span> <span class="na">options=</span><span class="s">&quot;{ascending:false}&quot;</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:scaleLineControl</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:mousePositionControl</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:overviewMapControl</span> <span class="nt">/&gt;</span>
                        <span class="nt">&lt;m:permalinkControl</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/m:map&gt;</span>
        <span class="nt">&lt;/h:panelGroup&gt;</span>
        <span class="nt">&lt;h:messages</span> <span class="na">id=</span><span class="s">&quot;msg&quot;</span> <span class="na">globalOnly=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;/h:messages&gt;</span>
        <span class="nt">&lt;fieldset&gt;</span>
                <span class="nt">&lt;legend&gt;</span>Consultas espaciais<span class="nt">&lt;/legend&gt;</span>
                <span class="nt">&lt;h:selectOneRadio</span> <span class="na">id=</span><span class="s">&quot;qryLanguage&quot;</span> <span class="na">value=</span><span class="s">&quot;#{queryViewManager.qryLanguage}&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;f:selectItem</span> <span class="na">itemLabel=</span><span class="s">&quot;Postgis&quot;</span> <span class="na">itemValue=</span><span class="s">&quot;POSTGIS&quot;</span><span class="nt">&gt;&lt;/f:selectItem&gt;</span>
                        <span class="nt">&lt;f:selectItem</span> <span class="na">itemLabel=</span><span class="s">&quot;JPQL&quot;</span> <span class="na">itemValue=</span><span class="s">&quot;JPQL&quot;</span><span class="nt">&gt;&lt;/f:selectItem&gt;</span>
                <span class="nt">&lt;/h:selectOneRadio&gt;</span>
                <span class="nt">&lt;h:inputTextarea</span> <span class="na">id=</span><span class="s">&quot;inputQuery&quot;</span> <span class="na">value=</span><span class="s">&quot;#{queryViewManager.query}&quot;</span> <span class="na">cols=</span><span class="s">&quot;60&quot;</span> <span class="na">rows=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;/h:inputTextarea&gt;</span>
                <span class="nt">&lt;p&gt;&lt;h:commandButton</span> <span class="na">value=</span><span class="s">&quot;Executar Consulta&quot;</span>
                <span class="na">action=</span><span class="s">&quot;#{queryViewManager.executeQuery}&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;f:ajax</span> <span class="na">execute=</span><span class="s">&quot;@this inputQuery qryLanguage&quot;</span> <span class="na">render=</span><span class="s">&quot;mapPanel msg&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/h:commandButton&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;/fieldset&gt;</span>
<span class="nt">&lt;/h:form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</td></tr></table></div>
<div class="highlight-java"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">latinoware</span><span class="o">.</span><span class="na">geodojo</span><span class="o">.</span><span class="na">beans</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.enterprise.inject.Model</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.faces.application.FacesMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.faces.context.FacesContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.EntityManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Query</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.ol4jsf.util.WKTFeaturesCollection</span><span class="o">;</span>

<span class="nd">@Model</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">QueryViewManager</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">EntityManager</span> <span class="n">em</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">query</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getQuery</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setQuery</span><span class="o">(</span><span class="n">String</span> <span class="n">query</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">wkts</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getWkts</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">wkts</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setWkts</span><span class="o">(</span><span class="n">String</span> <span class="n">wkts</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">wkts</span> <span class="o">=</span> <span class="n">wkts</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">qryLanguage</span> <span class="o">=</span> <span class="s">&quot;POSTGIS&quot;</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getQryLanguage</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">qryLanguage</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setQryLanguage</span><span class="o">(</span><span class="n">String</span> <span class="n">qryLanguage</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">qryLanguage</span> <span class="o">=</span> <span class="n">qryLanguage</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unchecked&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">executeQuery</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">WKTFeaturesCollection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">wktFeatures</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WKTFeaturesCollection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
            <span class="n">Query</span> <span class="n">q</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="s">&quot;POSTGIS&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">qryLanguage</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createNativeQuery</span><span class="o">(</span><span class="n">query</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">query</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;)</span> <span class="n">q</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
            <span class="n">wktFeatures</span><span class="o">.</span><span class="na">addAllFeatures</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>

            <span class="n">setWkts</span><span class="o">(</span><span class="n">wktFeatures</span><span class="o">.</span><span class="na">toMap</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">FacesContext</span><span class="o">.</span><span class="na">getCurrentInstance</span><span class="o">().</span><span class="na">addMessage</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">FacesMessage</span><span class="o">(</span><span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()));</span>
        <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p>Basicamente, no nosso bean adicionamos mais um atributo: qryLanguage. Esse atributo é setado pelo selectOneRadio da interface. No método executeQuery testamos o valor desse atributo e dependendo do seu valor executamos uma query nativa ou uma <em>java persistence query language</em> (JPQL). Simples assim! :)</p>
<p>Vamos repetir uma das consultas, agora utilizando JPQL:</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">select</span> <span class="n">theGeom</span> <span class="k">from</span> <span class="n">Municipio</span> <span class="k">where</span> <span class="n">nome</span> <span class="o">=</span> <span class="s1">&#39;ALTAMIRA&#39;</span><span class="p">;</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/ol4jsf_12.png"><img alt="../_images/ol4jsf_12.png" src="../_images/ol4jsf_12.png" style="width: 318.6px; height: 459.0px;" /></a>
<p>Percebam que não existe a necessidade de utilizar a função <em>st_astext()</em>, pois, na JPQL, o método toString() do objeto é chamado e já retorna o WKT relativo a <em>feature</em>.</p>
<p>Isso aí! O nosso visualizador de consultas versão 0.0.1a está protinho! O que acharam?</p>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <ul id="breadcrumbs">
            <li class="right" style="margin-right: 10px">
              <a href="../genindex.html" title="General Index"
                 >index</a></li>
            <li class="right" >
              <a href="../10-exemplo3/exemplo3.html" title="Exemplo 3"
                 >next</a> |</li>
            <li class="right" >
              <a href="../8-exemplo1/exemplo1.html" title="Exemplo1 - Enviando um geotwitt"
                 >previous</a> |</li>
        <li><a href="../index.html">GeoDOJO vGeoDOJO documentation</a> &raquo;</li>
        <li><a href="#">Exemplo2 - Construindo um visualizador de consultas espaciais</a></li>
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2010, Rafael Soto e Robert Anderson.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.4.
    </div>
  </body>
</html>