<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML+RDFa 1.0//EN" "http://www.w3.org/MarkUp/DTD/xhtml-rdfa-1.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" version="XHTML+RDFa 1.0" dir="ltr" class="js"><head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="Generator" content="Drupal 7 (http://drupal.org)">
    <!-- base href="https://www.e-education.psu.edu/geog489/node/2316" -->
    <title>4.12 Optional: Turning the Bus Event Analyzer into a QGIS Plugin</title>
    <script type="text/javascript" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/jquery.js"></script>
<script type="text/javascript" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/jquery-extend-3.js"></script>
<script type="text/javascript" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/jquery_002.js"></script>
<script type="text/javascript" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/drupal.js"></script>
<script type="text/javascript" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/shCore.js"></script>
<script type="text/javascript" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/shBrushBash.js"></script>
<script type="text/javascript" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/shBrushJScript.js"></script>
<script type="text/javascript" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/shBrushJson.js"></script>
<script type="text/javascript" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/shBrushPhp.js"></script>
<script type="text/javascript" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/shBrushPowerShell.js"></script>
<script type="text/javascript" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/shBrushPython.js"></script>
<script type="text/javascript" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/shBrushVb.js"></script>
<script type="text/javascript" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/printable_links.js"></script>
<script type="text/javascript" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/toggler.js"></script>
<script type="text/javascript" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/lti.js"></script>
<script type="text/javascript" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/h5p-resizer.js"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, {"basePath":"\/geog489\/","pathPrefix":"","ajaxPageState":{"theme":"gis","theme_token":"F-pa94jfO32cVU6UcaAXnQQYIyoEYUMzB6YfLODGonY","js":{"sites\/all\/modules\/jquery_update\/replace\/jquery\/1.7\/jquery.min.js":1,"misc\/jquery-extend-3.4.0.js":1,"misc\/jquery.once.js":1,"misc\/drupal.js":1,"sites\/all\/libraries\/syntaxhighlighter_3.0.83\/scripts\/shCore.js":1,"sites\/all\/libraries\/syntaxhighlighter_3.0.83\/scripts\/shBrushBash.js":1,"sites\/all\/libraries\/syntaxhighlighter_3.0.83\/scripts\/shBrushJScript.js":1,"sites\/all\/libraries\/syntaxhighlighter_3.0.83\/scripts\/shBrushJson.js":1,"sites\/all\/libraries\/syntaxhighlighter_3.0.83\/scripts\/shBrushPhp.js":1,"sites\/all\/libraries\/syntaxhighlighter_3.0.83\/scripts\/shBrushPowerShell.js":1,"sites\/all\/libraries\/syntaxhighlighter_3.0.83\/scripts\/shBrushPython.js":1,"sites\/all\/libraries\/syntaxhighlighter_3.0.83\/scripts\/shBrushVb.js":1,"sites\/all\/modules\/custom_js_libraries\/printable_links\/printable_links.js":1,"sites\/all\/modules\/custom_js_libraries\/toggler\/toggler.js":1,"sites\/all\/themes\/gis\/lti.js":1,"sites\/all\/themes\/gis\/..\/..\/modules\/h5p\/library\/js\/h5p-resizer.js":1}}});
//--><!]]>
</script>
        <meta name="robots" content="noindex, nofollow">        <style type="text/css" media="all">
@import url("https://www.e-education.psu.edu/geog489/modules/system/system.base.css?psbola");
@import url("https://www.e-education.psu.edu/geog489/modules/system/system.menus.css?psbola");
@import url("https://www.e-education.psu.edu/geog489/modules/system/system.messages.css?psbola");
@import url("https://www.e-education.psu.edu/geog489/modules/system/system.theme.css?psbola");
</style>
<style type="text/css" media="all">
@import url("https://www.e-education.psu.edu/geog489/modules/book/book.css?psbola");
@import url("https://www.e-education.psu.edu/geog489/modules/field/theme/field.css?psbola");
@import url("https://www.e-education.psu.edu/geog489/modules/node/node.css?psbola");
@import url("https://www.e-education.psu.edu/geog489/sites/all/modules/quiz/quiz.css?psbola");
@import url("https://www.e-education.psu.edu/geog489/modules/search/search.css?psbola");
@import url("https://www.e-education.psu.edu/geog489/modules/user/user.css?psbola");
@import url("https://www.e-education.psu.edu/geog489/sites/all/modules/extlink/extlink.css?psbola");
@import url("https://www.e-education.psu.edu/geog489/sites/all/modules/views/css/views.css?psbola");
</style>
<link type="text/css" rel="stylesheet" href="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/css.css" media="all">
<link type="text/css" rel="stylesheet" href="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/css_003.css" media="all">
<link type="text/css" rel="stylesheet" href="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/css_002.css" media="all">
<style type="text/css" media="all">
@import url("https://www.e-education.psu.edu/geog489/sites/all/modules/hidden_nodes/hidden_nodes.css?psbola");
@import url("https://www.e-education.psu.edu/geog489/sites/all/modules/ctools/css/ctools.css?psbola");
@import url("https://www.e-education.psu.edu/geog489/sites/all/libraries/syntaxhighlighter_3.0.83/styles/shCore.css?psbola");
@import url("https://www.e-education.psu.edu/geog489/sites/all/libraries/syntaxhighlighter_3.0.83/styles/shThemeDefault.css?psbola");
@import url("https://www.e-education.psu.edu/geog489/sites/all/modules/taxonomy_access/taxonomy_access.css?psbola");
@import url("https://www.e-education.psu.edu/geog489/sites/all/modules/print/print_ui/css/print_ui.theme.css?psbola");
@import url("https://www.e-education.psu.edu/geog489/sites/all/modules/print/css/print.css?psbola");
</style>
  </head>
  <body>
            <div class="print-site_name">Published on <em class="placeholder">GEOG 489: Advanced Python Programming for GIS</em> (<a href="https://www.e-education.psu.edu/geog489">https://www.e-education.psu.edu/geog489</a>)</div>
    <p>
    </p><div class="print-breadcrumb"><a href="https://www.e-education.psu.edu/geog489/home.html">Home</a> &gt; <a href="https://www.e-education.psu.edu/geog489/node/1405">GEOG 489</a> &gt; <a href="https://www.e-education.psu.edu/geog489/l4.html">Lesson 4 Object-Oriented Programming in Python and QGIS Development</a> &gt; 4.12 Optional: Turning the Bus Event Analyzer into a QGIS Plugin</div>
    <hr class="print-hr">
        <div class="print-content"><div id="node-2316" class="section-3">
  <h1 class="book-heading">4.12 Optional: Turning the Bus Event Analyzer into a QGIS Plugin</h1>
  <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even"><p><em>As
 said at the beginning of Section 4.11, this section about turning the 
Bus Track Analyzer code into a plugin that adds new layers to the 
current QGIS project and displays the analysis progress live on the map 
canvas can be considered optional. Feel free to just briefly skim 
through it&nbsp;and then watch the video from Section 4.12.7 showing the
 final Bus Track Analyzer for QGIS plugin. While creating&nbsp;a QGIS 
plugin yourself is one option that would give you full over&amp;above 
points in this lesson's homework assignment, the content of these two 
sections is not required for the assignment and the quiz. You can always
 come back to this section if you have time left at the end of this 
lesson or after the end of the class.</em></p>

<p>Now that you know how to create plugins for QGIS, let us apply this 
new knowledge to create a QGIS plugin version of our bus event analyzer 
from Section 4.10. We will call this plugin “Bus Track Analyzer for 
QGIS”. The process for this will be roughly as follows:</p>

<ul><li>Set up a new plugin with Plugin Builder using the Tool “button with dock widget” template</li>
	<li>Copy all the needed files from the project into the plugin folder</li>
	<li>Adapt the default GUI for the dock widget with QT Designer</li>
	<li>Make some smaller modifications to the project files including 
changes to class BusTrackAnalyzer to define QT signals that we can 
connect to</li>
	<li>Adapt the code in the dock widget class definition to wire up the 
GUI and to implement a modified version of the functionality we had in 
the main program in main.py of the Bus Track Analyzer project</li>
	<li>Implement and integrate a new class QGISEvenAndTrackLayerCreator 
that will be responsible for showing the bus tracks and events detected 
so far in the QGIS main map window during the analysis</li>
</ul></div></div></div>  <div id="node-2318" class="section-4">
  <h1 class="book-heading">4.12.1 Create Template with Plugin Builder</h1>
  <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even"><p>To create a folder with a template version for this plugin, please follow the steps below.</p>

<ol><li>Run the Plugin Builder plugin and fill out the first page as follows before clicking “Next &gt;”:
		<div class="img-center"><img alt=" Screenshot of plugin builder firstt page" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/create_plugin_1_0.jpg"><div class="img-caption">Figure 4.40 First Plugin Builder dialog page with information about the new plugin</div>
		</div>
	</li>
	<li>Just click “Next &gt;” again as we will skip the description part 
and then on the next page pick the “Tool button with dock widget” 
template at the top and fill out the rest of the information as shown 
below before pressing “Next &gt;” again.
		<div class="img-center"><img alt=" Screenshot of plugin builder with template selection--see caption" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/create_plugin_2.jpg"><div class="img-caption">Figure 4.41 Picking the "Tool button with dock widget" template in Plugin Builder</div>
		</div>
	</li>
	<li>We will keep the default settings for the following setup pages, so
 just keep pressing “Next &gt;” until you arrive at the last page where 
the button is called “Generate” instead. Take a look at the paths where 
Plugin Builder is going to create the folder for the new plugin. It 
might be a good idea to copy the path to somewhere where you can 
retrieve it at any time. Now click on “Generate” and the folder for the 
plugin will be created.</li>
	<li>If you now navigate to the plugins folder from the previous step, 
it will contain a new folder called “bustrackanalyzerforqgis”. Enter 
that folder and check out the files that have been created. The content 
should look like this:
		<div class="img-center"><img alt=" Screenshot of created file" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/create_plugin_3_0_0.jpg" style="width: 750px; height: 460px;"><div class="img-caption">Figure 4.42 Newly created plugin folder with files for our plugin</div>
		</div>
	</li>
	<li>Please close QGIS for a moment. We still need to compile the file 
resources.qrc into a Python .py file with the help of pyrcc5 as we did 
in Section 4.11. For this, run OSGeo4W.bat from your OSGeo4W/QGIS 
installation and in the shell that opens up, run the commands
		<pre class="brush: &lt;inserttype&gt;">py3_env 
qt5_env</pre>
	</li>
	<li>Now use cd to navigate to the folder containing your plugin, e.g. 
type in the following command but adapt the path to match the path from 
steps 3 and 4:
		<pre class="brush: &lt;inserttype&gt;">cd C:\Users\xyz\AppData\roaming\QGIS\QGIS3\profiles\default\python\plugins\bustrackanalyzerforqgis</pre>
	</li>
	<li>Finally, compile the file with the command below. There should now be a file called resources.py in your plugin folder.
		<pre class="brush: &lt;inserttype&gt;">pyrcc5 resources.qrc –o resources.py</pre>
	</li>
	<li>You can now restart QGIS and open the plugin manager where “Bus 
Track Analyzer for QGIS” should now appear in the list of installed 
plugins. Enable it and then check the Plugins menu to make sure there is
 now an entry “Bus Track Analyzer for QGIS” there. Start the plugin and a
 rather empty dock widget will appear in the right part of the QGIS 
window. Try moving this dock widget around. You will see that you can 
move it to the other areas of the main QGIS window or completely undock 
it and have it as an independent window on the screen.</li>
</ol></div></div></div>  </div>
<div id="node-2319" class="section-4">
  <h1 class="book-heading">4.12.2  Copy Files into Plugin Folder</h1>
  <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even"><p>For
 the next steps, it’s best if you again close QGIS for a bit. In case 
you made any changes to the files during the bus tracking project in 
Section 4.10, it would be best if you <a href="https://www.e-education.psu.edu/geog489/sites/www.e-education.psu.edu.geog489/files/downloads/bustrackanalyzer_complete.zip">re-download them from here</a> <span class="print-footnote">[1]</span>.
 Then copy the following&nbsp;files from the Section 4.10 project folder
 (if you didn't edit anything) or the fresh download into the folder for
 the Bus Tracker plugin:</p>

<pre class="brush: &lt;inserttype&gt;">bus_events.py 
bus_track_analyzer.py 
bus_tracker_widget.py 
core_classes.py 
dublin_bus_data.csv
dublin_depots.csv
status_driving.png 
status_indepot.png 
status_stopped.png 
</pre>

<p>Please note that we are intentionally not including main.py. Also, it
 wouldn’t really be necessary to include the input data sets (csv 
files), but there is also no harm in doing so, and it means that we have
 everything needed to create and run the plugin together in the same 
folder.</p>

<div class="img-center"><img alt=" Screenshot of selected files listed above" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/L4_copyfiles.jpg"> &nbsp; &nbsp; &nbsp;
	<div class="img-caption">Figure 4.43 Plugin folder with files from the Bus Track Analyzer project copied in&nbsp;</div>
</div>
</div></div></div>  </div>
<div id="node-2320" class="section-4">
  <h1 class="book-heading">4.12.3 Adapt the GUI with QT Designer</h1>
  <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even"><p>The
 GUI we will be using for our dock widget is shown in the image below. 
It has an area at the top where the user can select the GPS and depot 
input files and a button “Read and init” for reading in the data from 
the selected files. The central area contains a QScrollArea widget that 
will host our BusTrackerWidget in the same way as we had it embedded 
into the main window in the original project. In the area at the bottom,
 we have the controls for running the analysis consisting of three 
buttons “Stop and reset”, “Pause”, and “Start” and a QSlider widget for 
setting the delay between consecutive analysis steps. The image also 
shows the object names of the important GUI elements that will become 
instance variables of class BusTrackAnalyzerForQGISDockWidget that we 
can access and connect to.</p>

<div class="img-center"><img alt="screenshot of bus plugin with info like, pause, start, and delay slider labeled" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/L4_plugingui.jpg"> &nbsp; &nbsp; &nbsp;
	<div class="img-caption">Figure 4.44 GUI for the dock widget of our plugin with object names of the different GUI elements as labels</div>
</div>

<p>If you look at the files in the folder for our plugin, you will see 
that Plugin Builder has created a file called 
bus_track_analyzer_for_qgis_dockwidget.py. This file contains the 
definition of class BusTrackAnalyzerForQGISDockWidget derived from 
QDockWidget with the GUI for our plugin. The class itself directly reads
 the GUI specification from the file 
bus_track_analyzer_for_qgis_dockwidget_base.ui as explained in Section 
4.11.</p>

<p>So the next thing we are going to do is open that .ui file in QT 
Designer and modify it so that we get the GUI shown in the previous 
image. The image below shows the new GUI and its widget hierarchy in QT 
Designer. You don’t have to create this yourself. It is okay if you <a href="https://www.e-education.psu.edu/geog489/sites/www.e-education.psu.edu.geog489/files/downloads/bus_track_analyzer_for_qgis_dockwidget_base.zip">download the resulting .ui file</a> <span class="print-footnote">[2]</span>&nbsp;and
 extract it into the plugin folder overwriting the default file that is 
already there (you might need to rename the downloaded file to match the
 default file). Then open the .ui file in QT Designer for a moment and 
have a closer look at how the different widgets have been arranged.</p>

<div class="img-center"><img alt="screenshot of widgets and hierarchy" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/hierarchy_in_designer_0.jpg"> &nbsp; &nbsp; &nbsp;
	<div class="img-caption">Figure 4.45 GUI for our dock widget and widget hierarchy in QT Designer</div>
</div>
</div></div></div>  </div>
<div id="node-2321" class="section-4">
  <h1 class="book-heading">4.12.4 Modifications to the Original Project Files</h1>
  <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even"><p>The
 next thing we are going to do is make a few smaller changes to the 
files we copied over from the original project. First of all, it is 
unfortunately required that we adapt all import statements in which we 
are importing .py files located in the project folder. The reason is 
that when we write something like</p>

<pre class="brush: &lt;inserttype&gt;">from core_classes import BusTracker 
</pre>

<p>, this will work fine when the file core_classes.py is located in the
 current working directory when the program is executed. This is usually
 the same folder in which the main Python script is located. Therefore, 
we didn’t have any problems when executing main.py since main.py and the
 other .py files we wrote are all in the same directory. However, when 
being run as a QGIS plugin, the working directory will not be the folder
 containing the plugin code. As a result, you will get error messages 
when trying to import the other .py files like this. What we have to do 
is adapt the import statements to start with a dot which tells Python to
 look for the file <em>in the same folder the file in which the import statement appears is located</em>. So the previous example needs to become:</p>

<pre class="brush: &lt;inserttype&gt;">from .core_classes import BusTracker 
</pre>

<p>Here is quick overview of where we have to make these changes:</p>

<ol><li>In bus_events.py change the import statement at the beginning to:
		<div><div id="highlighter_701537" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python keyword">from</code> <code class="python plain">.core_classes </code><code class="python keyword">import</code> <code class="python plain">Depot, BusTracker</code></div></div></td></tr></tbody></table></div></div>
	</li>
	<li>In bus_track_analyzer.py change the two import statement at the beginning to:
		<div><div id="highlighter_296296" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python keyword">from</code> <code class="python plain">.bus_events </code><code class="python keyword">import</code> <code class="python plain">BusEvent </code></div><div class="line number2 index1 alt1"><code class="python keyword">from</code> <code class="python plain">.core_classes </code><code class="python keyword">import</code> <code class="python plain">BusTracker, Observation, Depot</code></div></div></td></tr></tbody></table></div></div>
	</li>
	<li>Lastly, in bus_tracker_widget.py change the import statement at the beginning to:
		<div><div id="highlighter_741837" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python keyword">from</code> <code class="python plain">.core_classes </code><code class="python keyword">import</code> <code class="python plain">BusTracker</code></div></div></td></tr></tbody></table></div></div>
	</li>
</ol><p>In addition to adapting the import statement, we are going to 
slightly adapt the bus_track_analyzer.py code to better work in concert 
with the GUI related classes of our plugin code: We are going to add the
 functionality to emit signals that we can connect to using the QT 
signal-slot approach. The two signals we are going to add are the 
following:</p>

<ul><li>observationProcessed: This signal will be emitted at the end of the <em>nextStep</em><em>()</em>
 method, so whenever the BusTrackAnalyzer object is done with processing
 one observation, the observation object that has just been processed 
will be included with the signal.</li>
	<li>eventDetected: This signal will be emitted for each new event that is added to the <em>allEvents</em> list. The emitted signal includes the new bus event object.</li>
</ul><p>Both signals will be used to connect an object of a new class we
 are going to write in Section 4.12.6 that has the purpose of showing 
the developing bus tracks and detected events live in QGIS. For this, it
 is required that the object is informed about newly processed 
observations and newly detected events, and this is what we are going to
 facilitate with these signals. Luckily, adding these signals to 
bus_track_analyzer.py just requires you to make a few small changes:</p>

<ol start="4"><li>Add the following PyQt5 import statement somewhere <em>before</em> line&nbsp;that starts the class definition with “class BusTrackAnalyzer …”:

		<div><div id="highlighter_508956" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python keyword">from</code> <code class="python plain">PyQt5.QtCore </code><code class="python keyword">import</code> <code class="python plain">QObject, pyqtSignal</code></div></div></td></tr></tbody></table></div></div>
	</li>
	<li>To be able to emit signals we need the class BusTrackerAnalyzer to 
be derived from the QT class QObject we are importing with the newly 
added import statement. Therefore, please change the first line of the 
class definition to:
		<div><div id="highlighter_392679" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python keyword">class</code> <code class="python plain">BusTrackAnalyzer(QObject):</code></div></div></td></tr></tbody></table></div></div>
	</li>
	<li>Then directly <em>before</em> the start of the constructor with 
“def __init__...", add the following two lines indented relative to the 
“class BusTrackAnalyzer…” but not part of any method:
		<div><div id="highlighter_985494" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python plain">observationProcessed </code><code class="python keyword">=</code> <code class="python plain">pyqtSignal(Observation) </code></div><div class="line number2 index1 alt1"><code class="python plain">eventDetected </code><code class="python keyword">=</code> <code class="python plain">pyqtSignal(BusEvent)</code></div></div></td></tr></tbody></table></div></div>

		<p>With these two lines we are defining the two signals that can be 
emitted by this class and the types of the parameters they will include.</p>
	</li>
	<li>Since we are now deriving BusTrackAnalyzer from QObject, we should 
call the constructor of the base class QObject from the first line of 
our <em>__init__(…) </em>method. So please add the following line there:
		<div><div id="highlighter_694910" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python functions">super</code><code class="python plain">(BusTrackAnalyzer, </code><code class="python color1">self</code><code class="python plain">).__init__()</code></div></div></td></tr></tbody></table></div></div>
	</li>
	<li>The last two changes we need to make are both in the definition of the <em>nextStep</em><em>()</em> method. We therefore show the entire new version of that method here:
		<div><div id="highlighter_68563" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python keyword">def</code> <code class="python plain">nextStep(</code><code class="python color1">self</code><code class="python plain">): </code></div><div class="line number2 index1 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments">"""performs next step by processing Observation at the front of the Observations priority queue"""</code></div><div class="line number3 index2 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">observation </code><code class="python keyword">=</code> <code class="python plain">heapq.heappop(</code><code class="python color1">self</code><code class="python plain">._observationQueue)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python comments"># get Observation that is at front of queue </code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments"># go through list of BusEvent subclasses and invoke their detect() method; then collect the events produced </code></div><div class="line number6 index5 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments"># and add them to the allEvents lists </code></div><div class="line number7 index6 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">for</code> <code class="python plain">evClass </code><code class="python keyword">in</code> <code class="python color1">self</code><code class="python plain">._eventClasses: </code></div><div class="line number8 index7 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">eventsProduced </code><code class="python keyword">=</code> <code class="python plain">evClass.detect(observation, </code><code class="python color1">self</code><code class="python plain">._depotData, </code><code class="python color1">self</code><code class="python plain">.allBusTrackers) </code><code class="python comments"># invoke event detection method </code></div><div class="line number9 index8 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.allEvents.extend(eventsProduced)&nbsp; </code><code class="python comments"># add resulting events to event list </code></div><div class="line number10 index9 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">for</code> <code class="python plain">event </code><code class="python keyword">in</code> <code class="python plain">eventsProduced:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code></div><div class="line number11 index10 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.eventDetected.emit(event) </code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments"># update BusTracker of Observation that was just processed </code></div><div class="line number14 index13 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">observation.busTracker.lastProcessedIndex </code><code class="python keyword">+</code><code class="python keyword">=</code> <code class="python value">1</code></div><div class="line number15 index14 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">observation.busTracker.updateSpeed() </code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">observation.busTracker.status </code><code class="python keyword">=</code><code class="python keyword">=</code> <code class="python plain">BusTracker.STATUS_STOPPED: </code><code class="python comments"># if&nbsp; duration of a stopped event has just expired, change status to "DRIVING" </code></div><div class="line number18 index17 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">observation.timepoint.time &gt; observation.busTracker.statusEvent.timepoint.time </code><code class="python keyword">+</code> <code class="python plain">observation.busTracker.statusEvent.duration: </code></div><div class="line number19 index18 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">observation.busTracker.status </code><code class="python keyword">=</code> <code class="python plain">BusTracker.STATUS_DRIVING </code></div><div class="line number20 index19 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">observation.busTracker.statusEvent </code><code class="python keyword">=</code> <code class="python color1">None</code></div><div class="line number21 index20 alt2">&nbsp;</div><div class="line number22 index21 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments"># if this was not the last GPS Timepoint of this bus, create new Observation for the next point and add it to the Observation queue </code></div><div class="line number23 index22 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">observation.timepointIndex &lt; </code><code class="python functions">len</code><code class="python plain">(observation.busTracker.bus.timepoints) </code><code class="python keyword">-</code> <code class="python value">1</code><code class="python plain">:&nbsp; </code><code class="python comments"># not last point </code></div><div class="line number24 index23 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">heapq.heappush(</code><code class="python color1">self</code><code class="python plain">._observationQueue, Observation(observation.busTracker, observation.timepointIndex </code><code class="python keyword">+</code> <code class="python value">1</code><code class="python plain">)&nbsp; )&nbsp; </code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments"># update analyzer status </code></div><div class="line number27 index26 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.lastProcessedTimepoint </code><code class="python keyword">=</code> <code class="python plain">observation.timepoint </code></div><div class="line number28 index27 alt1">&nbsp;</div><div class="line number29 index28 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.observationProcessed.emit(observation)</code></div></div></td></tr></tbody></table></div></div>

		<p>In lines 10 and 11&nbsp;of this new version we added a for-loop that goes through the events produced by the previous call of <em>detect(…)</em>
 and emit an eventDetected signal for each using the bus event object as
 a parameter. In the last line of the method, we do the same with the 
observationProcessed signal including the just processed Observation 
object.</p>
	</li>
</ol></div></div></div>  </div>
<div id="node-2322" class="section-4">
  <h1 class="book-heading">4.12.5 Implement Main Functionality in BusTrackAnalyzerForQGISDockWidget class</h1>
  <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even"><p>At
 this point, our plugin is still missing the code that ties everything 
together, that is, the code that reads in the data from the input files 
when the “Read and init” button is clicked and reacts to the control 
buttons at the bottom of the BusTrackAnalyzerForQGISDockWidget widget by
 starting to continuously call the analyzer’s <em>nextStep()</em> 
method, pausing that process, or completely resetting the analysis to 
start from the beginning. We are going to place the code for this 
directly in the definition of class BusTrackAnalyzerForQGISDockWidget in
 bus_track_analyzer_for_qgis_dockwidget.py, so you should open that file
 for editing now. Here is the code that needs to be added together with 
some explanations.</p>

<ol><li>First, we need to important quite a few classes from our own .py
 files and also a few additional PyQt5 classes; so please change the 
import statements at the beginning of the code to the following:
		<div><div id="highlighter_739778" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python keyword">import</code> <code class="python plain">os </code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="python keyword">from</code> <code class="python plain">PyQt5 </code><code class="python keyword">import</code> <code class="python plain">QtGui, QtWidgets, uic </code></div><div class="line number4 index3 alt1"><code class="python keyword">from</code> <code class="python plain">PyQt5.QtCore </code><code class="python keyword">import</code> <code class="python plain">pyqtSignal, QTimer, QCoreApplication </code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="python comments"># added imports </code></div><div class="line number7 index6 alt2"><code class="python keyword">from</code> <code class="python plain">.bus_track_analyzer </code><code class="python keyword">import</code> <code class="python plain">BusTrackAnalyzer </code></div><div class="line number8 index7 alt1"><code class="python keyword">from</code> <code class="python plain">.bus_tracker_widget </code><code class="python keyword">import</code> <code class="python plain">BusTrackerWidget </code></div><div class="line number9 index8 alt2"><code class="python comments">#from .qgis_event_and_track_layer_creator import QGISEventAndTrackLayerCreator </code></div><div class="line number10 index9 alt1"><code class="python keyword">from</code> <code class="python plain">.core_classes </code><code class="python keyword">import</code> <code class="python plain">Bus, Depot </code></div><div class="line number11 index10 alt2"><code class="python keyword">from</code> <code class="python plain">.bus_events </code><code class="python keyword">import</code> <code class="python plain">LeavingDepotEvent, EnteringDepotEvent, BusStoppedEvent, BusEncounterEvent </code></div></div></td></tr></tbody></table></div></div>

		<p>Note that we again have to use the notation with the dot at the 
beginning of the module names here. Also, please note that there is one 
import statement that is still commented out because it is for a class 
that we have not yet written. That will happen a bit later in Section 
4.12.6 and we will then uncomment this line.</p>
	</li>
	<li>
		<p>Next, we are going to add some initialization code to the constructor, directly after the last line of the <em>__init__(…)</em> method saying “self.setupUi(self)”:</p>

		<div><div id="highlighter_227002" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python comments"># own code added to template file </code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="python color1">self</code><code class="python plain">.running </code><code class="python keyword">=</code> <code class="python color1">False</code> <code class="python comments"># True if currently running analysis </code></div><div class="line number4 index3 alt1"><code class="python color1">self</code><code class="python plain">.delay </code><code class="python keyword">=</code> <code class="python value">0</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <code class="python comments"># delay between steps in milliseconds </code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="python color1">self</code><code class="python plain">.eventClasses </code><code class="python keyword">=</code> <code class="python plain">[ LeavingDepotEvent, EnteringDepotEvent, BusStoppedEvent, BusEncounterEvent ] </code><code class="python comments"># list of event classes to detect </code></div><div class="line number7 index6 alt2"><code class="python color1">self</code><code class="python plain">.busFileColumnIndices </code><code class="python keyword">=</code> <code class="python plain">{ </code><code class="python string">'lon'</code><code class="python plain">: </code><code class="python value">8</code><code class="python plain">, </code><code class="python string">'lat'</code><code class="python plain">: </code><code class="python value">9</code><code class="python plain">, </code><code class="python string">'busId'</code><code class="python plain">: </code><code class="python value">5</code><code class="python plain">, </code><code class="python string">'time'</code><code class="python plain">: </code><code class="python value">0</code><code class="python plain">, </code><code class="python string">'line'</code><code class="python plain">: </code><code class="python value">1</code> <code class="python plain">} </code><code class="python comments"># dictionary of column indices for required info </code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="python comments"># create initial BusTrackAnalyzer and BusTrackerWidget objects, and add the later to the scroll area of this widget </code></div><div class="line number10 index9 alt1"><code class="python color1">self</code><code class="python plain">.analyzer </code><code class="python keyword">=</code> <code class="python plain">BusTrackAnalyzer({}, [], </code><code class="python color1">self</code><code class="python plain">.eventClasses) </code></div><div class="line number11 index10 alt2"><code class="python color1">self</code><code class="python plain">.trackerWidget </code><code class="python keyword">=</code> <code class="python plain">BusTrackerWidget(</code><code class="python color1">self</code><code class="python plain">.analyzer) </code></div><div class="line number12 index11 alt1"><code class="python color1">self</code><code class="python plain">.busTrackerContainerWidget.layout().addWidget(</code><code class="python color1">self</code><code class="python plain">.trackerWidget,</code><code class="python value">0</code><code class="python plain">,</code><code class="python value">0</code><code class="python plain">) </code></div><div class="line number13 index12 alt2"><code class="python color1">self</code><code class="python plain">.layerCreator </code><code class="python keyword">=</code> <code class="python color1">None</code>&nbsp;&nbsp;&nbsp; <code class="python comments"># QGISEventAndTrackLayerCreator object, will only be initialized when input files are read </code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="python comments"># create a QTimer user to wait some time between steps&nbsp; </code></div><div class="line number16 index15 alt1"><code class="python color1">self</code><code class="python plain">.timer </code><code class="python keyword">=</code> <code class="python plain">QTimer() </code></div><div class="line number17 index16 alt2"><code class="python color1">self</code><code class="python plain">.timer.setSingleShot(</code><code class="python color1">True</code><code class="python plain">) </code></div><div class="line number18 index17 alt1"><code class="python color1">self</code><code class="python plain">.timer.timeout.connect(</code><code class="python color1">self</code><code class="python plain">.step) </code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="python comments"># set icons for play control buttons </code></div><div class="line number21 index20 alt2"><code class="python color1">self</code><code class="python plain">.startTB.setIcon(QCoreApplication.instance().style().standardIcon(QtWidgets.QStyle.SP_MediaPlay)) </code></div><div class="line number22 index21 alt1"><code class="python color1">self</code><code class="python plain">.pauseTB.setIcon(QCoreApplication.instance().style().standardIcon(QtWidgets.QStyle.SP_MediaPause)) </code></div><div class="line number23 index22 alt2"><code class="python color1">self</code><code class="python plain">.stopAndResetTB.setIcon(QCoreApplication.instance().style().standardIcon(QtWidgets.QStyle.SP_MediaSkipBackward)) </code></div><div class="line number24 index23 alt1">&nbsp;</div><div class="line number25 index24 alt2"><code class="python comments"># connect play control buttons and slide to respetive methods defined below </code></div><div class="line number26 index25 alt1"><code class="python color1">self</code><code class="python plain">.startTB.clicked.connect(</code><code class="python color1">self</code><code class="python plain">.start) </code></div><div class="line number27 index26 alt2"><code class="python color1">self</code><code class="python plain">.pauseTB.clicked.connect(</code><code class="python color1">self</code><code class="python plain">.stop) </code></div><div class="line number28 index27 alt1"><code class="python color1">self</code><code class="python plain">.stopAndResetTB.clicked.connect(</code><code class="python color1">self</code><code class="python plain">.reset) </code></div><div class="line number29 index28 alt2"><code class="python color1">self</code><code class="python plain">.delaySlider.valueChanged.connect(</code><code class="python color1">self</code><code class="python plain">.setDelay) </code></div><div class="line number30 index29 alt1">&nbsp;</div><div class="line number31 index30 alt2"><code class="python comments"># connect edit fields and buttons for selecting input files to respetive methods defined below </code></div><div class="line number32 index31 alt1"><code class="python color1">self</code><code class="python plain">.browseTrackFileTB.clicked.connect(</code><code class="python color1">self</code><code class="python plain">.selectTrackFile) </code></div><div class="line number33 index32 alt2"><code class="python color1">self</code><code class="python plain">.browseDepotFileTB.clicked.connect(</code><code class="python color1">self</code><code class="python plain">.selectDepotFile) </code></div><div class="line number34 index33 alt1"><code class="python color1">self</code><code class="python plain">.readAndInitPB.clicked.connect(</code><code class="python color1">self</code><code class="python plain">.readData)</code></div></div></td></tr></tbody></table></div></div>

		<p>What happens in this piece of code is the following:</p>

		<ul><li>First, we introduce some new instance variables for this class
 that are needed for reading data and setting up a BusTrackAnalyzer 
object (you probably recognize the variables <em>eventClasses</em> and <em>busFileColumnIndices</em> from the original main.py file) and for controlling the analysis steps. Variable <em>running</em> will be set to True when the analyzer’s <em>nextStep</em><em>()</em> method is supposed to be called continuously with small delays between the steps whose length is given by variable <em>delay</em>. It is certainly not optimal that the column indices for the GPS data file are hard-coded here in variable <em>busFileColumnIndices</em>
 but we decided against including an option for the user to specify 
these in this version to keep the GUI and code as simple as possible.</li>
			<li>In the next block of code, we create an instance variable to 
store the BusTrackAnalyzer object we will be using, and we create the 
BusTrackerWidget widget and place it within the scroll area in the 
center of the GUI. Since we have not read any input data yet, we are 
using an empty bus dictionary and empty depot list to set these things 
up.</li>
			<li>An instance variable for a QTimer object is created that will be used to queue up the execution of the method <em>step()</em> defined later when the widget is in continuous execution mode.</li>
			<li>The next code block simply sets the icons for the different control buttons at the bottom of the widget using standard QT icons.</li>
			<li>Next, we connect the “clicked” signals of the different control 
buttons to different methods of the class that are supposed to react to 
these signals. We do the same for the “valueChanged” signal of the 
QSlider widget in our GUI to be able to adapt the value of the variable <em>delay</em> when the slider is moved by the user.</li>
			<li>Finally, we link the three buttons at the top of the GUI for reading in the data to the respective event handler methods.</li>
		</ul></li>
	<li>
		<p>Now the last thing that needs to happen is adding the different 
event handler methods we have already been referring to in the 
previously added code. This is another larger chunk of code since there 
are quite a few methods to define. Please add the definitions at the end
 of the file after the definition of the method <em>closeEvent(…)</em> that is already there by default.</p>

		<div><div id="highlighter_470826" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments"># own methods added to template file </code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">def</code> <code class="python plain">selectTrackFile(</code><code class="python color1">self</code><code class="python plain">): </code></div><div class="line number4 index3 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments">"""displays open file dialog to select bus track input file"""</code></div><div class="line number5 index4 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">fileName, _ </code><code class="python keyword">=</code> <code class="python plain">QtWidgets.QFileDialog.getOpenFileName(</code><code class="python color1">self</code><code class="python plain">,</code><code class="python string">"Select CSV file with bus track data"</code><code class="python plain">, "</code><code class="python string">","</code><code class="python plain">(</code><code class="python keyword">*</code><code class="python plain">.</code><code class="python keyword">*</code><code class="python plain">)") </code></div><div class="line number6 index5 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">fileName: </code></div><div class="line number7 index6 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.trackFileNameLE.setText(fileName) </code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">def</code> <code class="python plain">selectDepotFile(</code><code class="python color1">self</code><code class="python plain">): </code></div><div class="line number10 index9 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments">"""displays open file dialog to select depot input file"""</code></div><div class="line number11 index10 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">fileName, _ </code><code class="python keyword">=</code> <code class="python plain">QtWidgets.QFileDialog.getOpenFileName(</code><code class="python color1">self</code><code class="python plain">,</code><code class="python string">"Select CSV file with depot data"</code><code class="python plain">, "</code><code class="python string">","</code><code class="python plain">(</code><code class="python keyword">*</code><code class="python plain">.</code><code class="python keyword">*</code><code class="python plain">)") </code></div><div class="line number12 index11 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">fileName: </code></div><div class="line number13 index12 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.depotFileNameLE.setText(fileName) </code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">def</code> <code class="python plain">readData(</code><code class="python color1">self</code><code class="python plain">): </code></div><div class="line number16 index15 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments">"""reads bus track and depot data from selected files and creates new analyzer and creates analyzer and layer creator for new input"""</code></div><div class="line number17 index16 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python color1">self</code><code class="python plain">.running: </code></div><div class="line number18 index17 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.stop() </code></div><div class="line number19 index18 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">try</code><code class="python plain">:&nbsp;&nbsp; </code><code class="python comments"># read data </code></div><div class="line number20 index19 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">depotData </code><code class="python keyword">=</code> <code class="python plain">Depot.readFromCSV(</code><code class="python color1">self</code><code class="python plain">.depotFileNameLE.text())&nbsp;&nbsp; </code></div><div class="line number21 index20 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">busData </code><code class="python keyword">=</code> <code class="python plain">Bus.readFromCSV(</code><code class="python color1">self</code><code class="python plain">.trackFileNameLE.text(), </code><code class="python color1">self</code><code class="python plain">.busFileColumnIndices)&nbsp; </code></div><div class="line number22 index21 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">except</code> <code class="python plain">Exception as e: </code></div><div class="line number23 index22 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">QtWidgets.QMessageBox.information(</code><code class="python color1">self</code><code class="python plain">, </code><code class="python string">'Operation failed'</code><code class="python plain">, </code><code class="python string">'Could not read data from files provided: '</code><code class="python keyword">+</code> <code class="python functions">str</code><code class="python plain">(e.__class__) </code><code class="python keyword">+</code> <code class="python string">': '</code> <code class="python keyword">+</code> <code class="python functions">str</code><code class="python plain">(e), QtWidgets.QMessageBox.Ok) </code></div><div class="line number24 index23 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">busData </code><code class="python keyword">=</code> <code class="python plain">{} </code></div><div class="line number25 index24 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">depotData </code><code class="python keyword">=</code> <code class="python plain">[] </code></div><div class="line number26 index25 alt1">&nbsp;</div><div class="line number27 index26 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments"># create new analyzer and layer creator objects and connect them </code></div><div class="line number28 index27 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.analyzer </code><code class="python keyword">=</code> <code class="python plain">BusTrackAnalyzer(busData, depotData, </code><code class="python color1">self</code><code class="python plain">.eventClasses) </code></div><div class="line number29 index28 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.trackerWidget.analyzer </code><code class="python keyword">=</code> <code class="python color1">self</code><code class="python plain">.analyzer </code></div><div class="line number30 index29 alt1"><code class="python comments">#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; self.createLayerCreator() </code></div><div class="line number31 index30 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.trackerWidget.updateContent() </code></div><div class="line number32 index31 alt1">&nbsp;</div><div class="line number33 index32 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">def</code> <code class="python plain">stop(</code><code class="python color1">self</code><code class="python plain">): </code></div><div class="line number34 index33 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments">"""halts analysis but analysis can be continued from this point"""</code></div><div class="line number35 index34 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.timer.stop() </code></div><div class="line number36 index35 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.running </code><code class="python keyword">=</code> <code class="python color1">False</code></div><div class="line number37 index36 alt2">&nbsp;</div><div class="line number38 index37 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">def</code> <code class="python plain">reset(</code><code class="python color1">self</code><code class="python plain">): </code></div><div class="line number39 index38 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments">"""halts analysis and resets analyzer to start from the beginning"""</code></div><div class="line number40 index39 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.stop() </code></div><div class="line number41 index40 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.analyzer.reset() </code></div><div class="line number42 index41 alt1"><code class="python comments">#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; self.createLayerCreator() </code></div><div class="line number43 index42 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.trackerWidget.updateContent() </code></div><div class="line number44 index43 alt1">&nbsp;</div><div class="line number45 index44 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">def</code> <code class="python plain">start(</code><code class="python color1">self</code><code class="python plain">): </code></div><div class="line number46 index45 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments">"""starts analysis if analysis isn't already running"""</code></div><div class="line number47 index46 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python keyword">not</code> <code class="python color1">self</code><code class="python plain">.running: </code></div><div class="line number48 index47 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.running </code><code class="python keyword">=</code> <code class="python color1">True</code></div><div class="line number49 index48 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.step() </code></div><div class="line number50 index49 alt1">&nbsp;</div><div class="line number51 index50 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">def</code> <code class="python plain">step(</code><code class="python color1">self</code><code class="python plain">): </code></div><div class="line number52 index51 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments">"""performs a single analysis step of the BusTrackAnalyzer but starts singleshot timer after each step to call itself again"""</code></div><div class="line number53 index52 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python color1">self</code><code class="python plain">.running: </code></div><div class="line number54 index53 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python color1">self</code><code class="python plain">.analyzer.isFinished(): </code></div><div class="line number55 index54 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.stop() </code></div><div class="line number56 index55 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">else</code><code class="python plain">: </code></div><div class="line number57 index56 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.analyzer.nextStep()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python comments"># perform next analysis step </code></div><div class="line number58 index57 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.trackerWidget.updateContent()&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python comments"># redraw tracker widget&nbsp; </code></div><div class="line number59 index58 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.timer.start(</code><code class="python functions">max</code><code class="python plain">([</code><code class="python value">5</code><code class="python plain">,</code><code class="python color1">self</code><code class="python plain">.delay])) </code><code class="python comments"># start timer to call this method again after delay </code></div><div class="line number60 index59 alt1">&nbsp;</div><div class="line number61 index60 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">def</code> <code class="python plain">setDelay(</code><code class="python color1">self</code><code class="python plain">): </code></div><div class="line number62 index61 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments">"""adapt delay when slider has been moved"""</code></div><div class="line number63 index62 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.delay </code><code class="python keyword">=</code> <code class="python value">10</code> <code class="python keyword">*</code> <code class="python color1">self</code><code class="python plain">.delaySlider.value() </code></div><div class="line number64 index63 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python color1">self</code><code class="python plain">.running:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python comments"># if analysis is running, change to the new delay immediately </code></div><div class="line number65 index64 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.timer.stop() </code></div><div class="line number66 index65 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.timer.start(</code><code class="python functions">max</code><code class="python plain">([</code><code class="python value">5</code><code class="python plain">,</code><code class="python color1">self</code><code class="python plain">.delay]))</code></div></div></td></tr></tbody></table></div></div>
	</li>
</ol><p>The first two methods <em>selectTrackFile()</em> and <em>selectDepotFile()</em> are called when the “…” buttons at the top are clicked and will open file dialog boxes for picking the input files. The method <em>readData()</em>
 is invoked when the “Read and init” button is clicked. It stops all 
ongoing executions of the analyzer, attempts to read the data from the 
selected files, and then creates a new BusTrackAnalyzer object for this 
input data and connects it to the BusTrackerWidget in our GUI. The code 
of this function contains another two lines that are&nbsp;commented out 
and that we will uncomment later.</p>

<p>The other methods we define in this piece of code are the event handler functions for the control buttons at the bottom:</p>

<ul><li><em>stop()</em> is called when the “Pause” button in the middle 
is clicked and simply stops the timer if its currently running and sets 
the variable <em>running</em> to False so that the analyzer’s <em>nextStep</em><em>()</em> method won’t be called anymore.</li>
	<li><em>reset()</em> is called when the control button on the left is 
called and it also stops the execution but, in addition, resets the 
analyzer so that the analysis will start from the beginning when the 
“Start” button is clicked again.</li>
	<li><em>start()</em> is called when the right control button (“Play”) 
for continuously performing analysis steps is clicked. It sets variable 
running to True and then invokes method&nbsp;<em>step()</em> to run the first analysis step.</li>
	<li><em>step()</em> is either called from <em>start()</em> or by the timer it sets up itself after each call of the analyzer’s <em>nextStep</em><em>()</em>
 method to perform the next analysis step after a certain delay until 
all observation have been processed. Please note that we are using 
minimum delay of 5 milliseconds to make sure that the QGIS GUI remains 
responsive while we are running the analysis.</li>
	<li><em>setDelay()</em> is called when the slider is moved and it 
translates the slider position into a delay value between 0 and 1 
second. It also immediately restarts the timer to use this new <em>delay</em> value.</li>
</ul><p>Our plugin is operational now and you can open QGIS and run it. 
In case you already have QGIS running or you encounter any errors that 
need to be fixed, don’t forget to reload the plugin code with the help 
of the Plugin Reloader plugin. Once the dock widget appears at the right
 side of the QGIS window (as shown in the figure below), do the 
following:</p>

<ol><li>Use the “…” buttons to select the input files for the bus GPS and depot data.</li>
	<li>Click “Read and init”; after that you should see the initial bus tracker configuration in the central area of the dock widget.</li>
	<li>Press the “Play” button to start the analysis; the content of the 
BusTrackerWidget should now continuously update to reflect the current 
state of the analysis</li>
	<li>Test out the “Pause” and “Rewind” buttons as well as changing the 
delay between steps with the slider to control the speed the analysis is
 run at.</li>
</ol><div class="img-center"><img alt=" Screenshot of map next to window with individual bus information " src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/plugin_in_qgis.jpg"><div class="img-caption">Figure 4.46 The plugin running in QGIS showing the current status of the analysis and individual buses</div>
</div>

<p>So far, so good. We have now turned our original standalone project 
into a QGIS plugin and even added in some extra functionality allowing 
the user to pause and restart the analysis and control the speed. 
However, typically a QGIS plugin in some way interacts with the content 
of the project that is currently open in QGIS, for instance by taking 
some of its layers as input or adding new layers to the project. We will
 add this kind of functionality in the next section and this will be the
 final addition we are making to our plugin.</p>
</div></div></div>  </div>
<div id="node-2325" class="section-4">
  <h1 class="book-heading">4.12.6 Create and Integrate New Class QGISEventAndTrackLayerCreator</h1>
  <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even"><p>In
 addition to showing the current bus tracker states in the dock widget, 
we want our plugin to add two new layers to the currently open QGIS 
project that show the progress of the analysis and once the analysis is 
finished contain its results. The two layers will correspond to the two 
output files we produced in the original project in Section 4.10:</p>

<ul><li>a polyline layer showing routes taken by the different bus vehicles with the bus IDs as attribute,</li>
	<li>a point layer showing the detected events with the type of the event and a short description as attributes.</li>
</ul><p>Since we don’t want to just produce these layers at the end of 
the analysis but want these to be there from the start of the analysis 
and continuously update whenever a new bus GPS observation is processed 
or an event is detected, we are going to write some code that reacts to 
the observationProcessed and eventDetected signals emitted by our class 
BusTrackAnalyzer (see the part of Section 4.12.4&nbsp;where we added 
these signals). We will define a new class for all&nbsp;this that will 
be called QGISEventAndTrackLayerCreator and it will be defined in a new 
file qgis_event_and_track_layer_creator.py. The class definition 
consists of the constructor and two methods called <em>addObservationToTrack(…)</em> and <em>addEvent(…)</em> that will be connected to the corresponding signals of the analyzer.</p>

<p>Let’s start with the beginning of the class definition and the 
constructor. All following code needs to be placed in file 
qgis_event_and_track_layer_creator.py that you need to create in the 
plugin folder.</p>

<div><div id="highlighter_584386" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python keyword">import</code> <code class="python plain">qgis </code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="python keyword">class</code> <code class="python plain">QGISEventAndTrackLayerCreator(): </code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">def</code> <code class="python plain">__init__(</code><code class="python color1">self</code><code class="python plain">): </code></div><div class="line number6 index5 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">._features </code><code class="python keyword">=</code> <code class="python plain">{}&nbsp;&nbsp;&nbsp; </code><code class="python comments"># dictionary mapping bus id string to polyline feature in bus track layer&nbsp; </code></div><div class="line number7 index6 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">._pointLists </code><code class="python keyword">=</code> <code class="python plain">{}&nbsp; </code><code class="python comments"># dictionary mapping bus id string to list of QgsPointXY objects for creating the poylines from </code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments"># get project currently open in QGIS </code></div><div class="line number10 index9 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">currentProject </code><code class="python keyword">=</code> <code class="python plain">qgis.core.QgsProject.instance() </code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments"># create track layer and symbology, then add to current project&nbsp;&nbsp; </code></div><div class="line number13 index12 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.trackLayer </code><code class="python keyword">=</code> <code class="python plain">qgis.core.QgsVectorLayer(</code><code class="python string">'LineString?crs=EPSG:4326&amp;field=BUS_ID:integer'</code><code class="python plain">, </code><code class="python string">'Bus tracks'</code> <code class="python plain">, </code><code class="python string">'memory'</code><code class="python plain">) </code></div><div class="line number14 index13 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.trackProv </code><code class="python keyword">=</code> <code class="python color1">self</code><code class="python plain">.trackLayer.dataProvider() </code></div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">lineMeta </code><code class="python keyword">=</code> <code class="python plain">qgis.core.QgsApplication.symbolLayerRegistry().symbolLayerMetadata(</code><code class="python string">"SimpleLine"</code><code class="python plain">) </code></div><div class="line number17 index16 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">lineLayer </code><code class="python keyword">=</code> <code class="python plain">lineMeta.createSymbolLayer({</code><code class="python string">'color'</code><code class="python plain">: </code><code class="python string">'0,0,0'</code><code class="python plain">}) </code></div><div class="line number18 index17 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">markerMeta </code><code class="python keyword">=</code> <code class="python plain">qgis.core.QgsApplication.symbolLayerRegistry().symbolLayerMetadata(</code><code class="python string">"MarkerLine"</code><code class="python plain">) </code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">markerLayer </code><code class="python keyword">=</code> <code class="python plain">markerMeta.createSymbolLayer({</code><code class="python string">'width'</code><code class="python plain">: </code><code class="python string">'0.26'</code><code class="python plain">, </code><code class="python string">'color'</code><code class="python plain">: </code><code class="python string">'0,0,0'</code><code class="python plain">, </code><code class="python string">'placement'</code><code class="python plain">: </code><code class="python string">'lastvertex'</code><code class="python plain">}) </code></div><div class="line number21 index20 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">symbol </code><code class="python keyword">=</code> <code class="python plain">qgis.core.QgsSymbol.defaultSymbol(</code><code class="python color1">self</code><code class="python plain">.trackLayer.geometryType()) </code></div><div class="line number22 index21 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">symbol.deleteSymbolLayer(</code><code class="python value">0</code><code class="python plain">) </code></div><div class="line number23 index22 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">symbol.appendSymbolLayer(lineLayer) </code></div><div class="line number24 index23 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">symbol.appendSymbolLayer(markerLayer) </code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">trackRenderer </code><code class="python keyword">=</code> <code class="python plain">qgis.core.QgsSingleSymbolRenderer(symbol) </code></div><div class="line number27 index26 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.trackLayer.setRenderer(trackRenderer) </code></div><div class="line number28 index27 alt1">&nbsp;</div><div class="line number29 index28 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">currentProject.addMapLayer(</code><code class="python color1">self</code><code class="python plain">.trackLayer) </code></div><div class="line number30 index29 alt1">&nbsp;</div><div class="line number31 index30 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments"># create event layer and symbology, then add to current project </code></div><div class="line number32 index31 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.eventLayer </code><code class="python keyword">=</code> <code class="python plain">qgis.core.QgsVectorLayer(</code><code class="python string">'Point?crs=EPSG:4326&amp;field=TYPE:string(50)&amp;field=INFO:string(255)'</code><code class="python plain">, </code><code class="python string">'Bus events'</code> <code class="python plain">, </code><code class="python string">'memory'</code><code class="python plain">) </code></div><div class="line number33 index32 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.eventProv </code><code class="python keyword">=</code> <code class="python color1">self</code><code class="python plain">.eventLayer.dataProvider() </code></div><div class="line number34 index33 alt1">&nbsp;</div><div class="line number35 index34 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">colors </code><code class="python keyword">=</code> <code class="python plain">{ </code><code class="python string">"BusEncounterEvent"</code><code class="python plain">: </code><code class="python string">'yellow'</code><code class="python plain">, </code><code class="python string">"BusStoppedEvent"</code><code class="python plain">: </code><code class="python string">'orange'</code><code class="python plain">, </code><code class="python string">"EnteringDepotEvent"</code><code class="python plain">: </code><code class="python string">'blue'</code><code class="python plain">, </code><code class="python string">"LeavingDepotEvent"</code><code class="python plain">: </code><code class="python string">'green'</code> <code class="python plain">} </code></div><div class="line number36 index35 alt1">&nbsp;</div><div class="line number37 index36 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">categories </code><code class="python keyword">=</code> <code class="python plain">[] </code></div><div class="line number38 index37 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">for</code> <code class="python plain">ev </code><code class="python keyword">in</code> <code class="python plain">colors: </code></div><div class="line number39 index38 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">categories.append( qgis.core.QgsRendererCategory( ev, qgis.core.QgsMarkerSymbol.createSimple({</code><code class="python string">'name'</code><code class="python plain">: </code><code class="python string">'square'</code><code class="python plain">, </code><code class="python string">'size'</code><code class="python plain">: </code><code class="python string">'3.0'</code><code class="python plain">, </code><code class="python string">'color'</code><code class="python plain">: colors[ev]}), ev )) </code></div><div class="line number40 index39 alt1">&nbsp;</div><div class="line number41 index40 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">eventRenderer </code><code class="python keyword">=</code> <code class="python plain">qgis.core.QgsCategorizedSymbolRenderer(</code><code class="python string">"TYPE"</code><code class="python plain">, categories) </code></div><div class="line number42 index41 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.eventLayer.setRenderer(eventRenderer) </code></div><div class="line number43 index42 alt2">&nbsp;</div><div class="line number44 index43 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">currentProject.addMapLayer(</code><code class="python color1">self</code><code class="python plain">.eventLayer) </code></div></div></td></tr></tbody></table></div></div>

<p>To be able to build polylines for the bus tracks and update these 
whenever a new observation has been processed by the analyzer, we need 
to maintain dictionaries with the QGIS features and point lists for each
 bus vehicle track. These are created at the beginning of the 
constructor code in lines 6 and 7. In addition, the constructor accesses
 the currently open QGIS project (line 10) and adds to the two new 
layers called “Bus tracks” and “Bus events” to it (lines 29 and 44). The
 rest of the code is mainly for setting the symbology of these two 
layers: For the track layer, we use black lines with a red circle marker
 at the end to indicate the current location of the vehicle (lines 
16&nbsp;to 27) as shown in the image below. For the events, we use 
square markers in different colors based on the TYPE of the event (lines
 35 to 42).</p>

<div class="img-center"><img alt=" Screenshot of what the text content above describes. Tracks marked with bus events" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/L4_QGIS_symbologies_0.jpg"> &nbsp; &nbsp; &nbsp;
	<div class="img-caption">Figure 4.47 QGIS symbology used for the bus track and event layers</div>
</div>

<p>Now we are going to add the definition of the method <em>addObservationToTrack(…)</em> that will be connected to the observationProcessed signal emitted when the analyzer object has completed the execution of <em>nextStep</em><em>()</em>.</p>

<div><div id="highlighter_585713" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python keyword">def</code> <code class="python plain">addObservationToTrack(</code><code class="python color1">self</code><code class="python plain">, observation): </code></div><div class="line number2 index1 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments">"""add new vertex to a bus polyline based on the given Observation object"""</code></div><div class="line number3 index2 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">busId </code><code class="python keyword">=</code> <code class="python plain">observation.busTracker.bus.busId; </code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments"># create new point for this observation </code></div><div class="line number6 index5 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">p </code><code class="python keyword">=</code>&nbsp; <code class="python plain">qgis.core.QgsPointXY(observation.timepoint.lon, observation.timepoint.lat) </code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments"># add point to point list and (re)create polyline geometry </code></div><div class="line number9 index8 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">busId </code><code class="python keyword">in</code> <code class="python color1">self</code><code class="python plain">._features:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python comments"># we already have a point list and polyline feature for this bus </code></div><div class="line number10 index9 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">feat </code><code class="python keyword">=</code> <code class="python color1">self</code><code class="python plain">._features[busId] </code></div><div class="line number11 index10 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">points </code><code class="python keyword">=</code> <code class="python color1">self</code><code class="python plain">._pointLists[busId] </code></div><div class="line number12 index11 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">points.append(p) </code></div><div class="line number13 index12 alt2">&nbsp;</div><div class="line number14 index13 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments"># recreate polyline geometry and replace in layer </code></div><div class="line number15 index14 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">polyline </code><code class="python keyword">=</code> <code class="python plain">qgis.core.QgsGeometry.fromPolylineXY(points) </code></div><div class="line number16 index15 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.trackProv.changeGeometryValues({feat.</code><code class="python functions">id</code><code class="python plain">(): polyline}) </code></div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">else</code><code class="python plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python comments"># new bus id we haven't seen before </code></div><div class="line number19 index18 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments"># create new&nbsp; polyline and feature&nbsp;&nbsp;&nbsp;&nbsp; </code></div><div class="line number20 index19 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">polyline </code><code class="python keyword">=</code> <code class="python plain">qgis.core.QgsGeometry.fromPolylineXY([p]) </code></div><div class="line number21 index20 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">feat </code><code class="python keyword">=</code> <code class="python plain">qgis.core.QgsFeature() </code></div><div class="line number22 index21 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">feat.setGeometry(polyline) </code></div><div class="line number23 index22 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">feat.setAttributes([</code><code class="python functions">int</code><code class="python plain">(busId)]) </code></div><div class="line number24 index23 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">_, f </code><code class="python keyword">=</code> <code class="python color1">self</code><code class="python plain">.trackProv.addFeatures([feat]) </code></div><div class="line number25 index24 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments"># store point list and polyline feature in respective dictionaries </code></div><div class="line number26 index25 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">._features[busId] </code><code class="python keyword">=</code> <code class="python plain">f[</code><code class="python value">0</code><code class="python plain">] </code></div><div class="line number27 index26 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">._pointLists[busId] </code><code class="python keyword">=</code> <code class="python plain">[p] </code></div><div class="line number28 index27 alt1">&nbsp;</div><div class="line number29 index28 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments"># force redraw of layer </code></div><div class="line number30 index29 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.trackLayer.triggerRepaint() </code></div><div class="line number31 index30 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">qgis.utils.iface.mapCanvas().refresh()</code></div></div></td></tr></tbody></table></div></div>

<p>The Observation object given to this method as a parameter provides 
us with access to all the relevant information we need to update the 
polyline feature for the bus this observation is about. First, we 
extract the ID of the bus (line 3) and create a new QgsPointXY object 
from the Timepoint stored in the Observation object (line 6). If we 
already have a polyline feature for this vehicle, we get the 
corresponding feature and point lists from the <em>features</em> and <em>pointLists</em>
 dictionaries, add the new point to the point list and create a new 
polyline geometry from it, and finally change the geometry of that 
feature in the bus track layer to this new geometry (lines 10 to 16). If
 instead this is the first observation of this vehicle, we create a 
point list for it to be stored in the <em>pointList</em> dictionary as 
well as a new polyline geometry with just that single point,&nbsp;and we
 then set up a new QgsFeature object for this polyline that is added to 
the bus track layer and also the features dictionary (lines 19 to 27). 
At the very end of the method, we make sure that the layer is repainted 
in the QGIS map canvas.</p>

<p>Now we add the code for the <em>addEvent(…)</em> method completing the definition of our class QGISEventAndTrackLayerCreator:</p>

<div><div id="highlighter_270660" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python keyword">def</code> <code class="python plain">addEvent(</code><code class="python color1">self</code><code class="python plain">, busEvent): </code></div><div class="line number2 index1 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments">"""add new event point feature to event layer based on the given BusEvent object"""</code></div><div class="line number3 index2 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments"># create point feature with information from busEvent </code></div><div class="line number4 index3 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">p </code><code class="python keyword">=</code>&nbsp; <code class="python plain">qgis.core.QgsPointXY(busEvent.timepoint.lon, busEvent.timepoint.lat) </code></div><div class="line number5 index4 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">feat </code><code class="python keyword">=</code> <code class="python plain">qgis.core.QgsFeature() </code></div><div class="line number6 index5 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">feat.setGeometry(qgis.core.QgsGeometry.fromPointXY(p)) </code></div><div class="line number7 index6 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">feat.setAttributes([</code><code class="python functions">type</code><code class="python plain">(busEvent).__name__, busEvent.description()]) </code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments"># add feature to event layer and force redraw </code></div><div class="line number10 index9 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.eventProv.addFeatures([feat]) </code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.eventLayer.triggerRepaint() </code></div><div class="line number13 index12 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">qgis.utils.iface.mapCanvas().refresh()</code></div></div></td></tr></tbody></table></div></div>

<p>This method is much simpler because we don’t have to modify existing 
features in the layer but rather always add one new point feature to the
 event layer. All information required for this is taken from the bus 
event object given as a parameter: The coordinates for the next point 
feature are taken from the Timepoint stored in the event object (line 
4), for the TYPE field of the event we take the type of the event object
 (line 7), and for the INFO field we take the string returned by calling
 the event object’s <em>description(…)</em> method (also line 7).</p>

<p>To incorporate this new class into our current plugin, we need to 
make a few more modification to the class 
BusTrackAnalyzerForQGISDockWidget in file 
bus_track_analyzer_for_qgis_dock_widget.py. Here are the instructions 
for this:</p>

<ol><li>Remove the # at the beginning of the line “from 
.qgis_event_and_track_layer_creator import …” to uncomment this line and
 import our new class.</li>
	<li>Now we add a new auxiliary method to the class definition that has 
the purpose of creating an object of our new class 
BusTrackAnalyzerForQGISDockWidget and connecting its methods to the 
corresponding signals of the analyzer object. Add the following 
definition as the first method after the “closeEvent” method, so 
directly after the comment “# own methods added to the template file”.
		<div><div id="highlighter_737665" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python keyword">def</code> <code class="python plain">createLayerCreator(</code><code class="python color1">self</code><code class="python plain">): </code></div><div class="line number2 index1 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments">"""creates a new QGISEventAndTrackLayerCreator for showing events and tracks on main QGIS window and connects it to analyzer"""</code></div><div class="line number3 index2 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.layerCreator </code><code class="python keyword">=</code> <code class="python plain">QGISEventAndTrackLayerCreator() </code></div><div class="line number4 index3 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.analyzer.observationProcessed.connect(</code><code class="python color1">self</code><code class="python plain">.layerCreator.addObservationToTrack) </code></div><div class="line number5 index4 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python color1">self</code><code class="python plain">.analyzer.eventDetected.connect(</code><code class="python color1">self</code><code class="python plain">.layerCreator.addEvent) </code></div></div></td></tr></tbody></table></div></div>

		<p>We already set up an instance variable <em>layerCreator</em> in the
 constructor code and we are using it here for storing the newly created
 layer creator object. Then we connect the signals to the two methods of
 the layer creator object.</p>
	</li>
	<li>Now we just need to uncomment two lines to make sure that the method <em>createLayerCreator()</em>
 is called at the right places, namely after we read in data from the 
input files and when the analyzer is resetted. In both cases, we want to
 create a new layer creator object that will set up two new layers in 
the current QGIS project. The lines that you need to uncomment for this 
by removing the leading # are:
		<ul><li>the line “# self.createLayerCreator()” in method <em>readData()</em></li>
			<li>the line “# self.createLayerCreator()” in method <em>reset()</em></li>
		</ul><p>You should make sure that the indentation is correct after removing the hashmarks.</p>
	</li>
</ol><p>That’s it, we are done with the code for our plugin!</p>
</div></div></div>  </div>
<div id="node-2359" class="section-4">
  <h1 class="book-heading">4.12.7 Try It Out</h1>
  <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even"><p>To
 try out this new version of the plugin, close the dock widget if it’s 
currently still open in QGIS and then run the Plugin Reloader plugin to 
load this updated version of our plugin. Add a basemap to your map 
project and zoom it to the general area of Dublin. When you then load 
the input files, you will see the two new layers appear in the layer 
list of the current QGIS project with the symbology we are setting up in
 the code. When you now start the analysis, what you see should look 
like the video below with the bus tracker widget continuously updating 
the bus status information, the bus tracks starting to appear in the 
QGIS map window, and square symbols starting to pop up for the events 
detected.</p>

<p>[NOTE:&nbsp; This video (3:04) does NOT contain sound]</p>

<div class="video-wrapper"><iframe allow="autoplay; encrypted-media" allowfullscreen="" src="https://www.youtube.com/embed/dr17yBcZygs?rel=0&amp;showinfo=0" frameborder="0" width="560" height="315"></iframe></div>

<p>The delay slider can be used to increase the breaks between two 
analysis steps, which can be helpful if the map window doesn’t seem to 
update properly because QGIS has problems catching up with the requests 
to repaint layers. This in particular is a good idea if you want to pan 
and zoom the map in which case you may notice the basemap tiles not 
appearing if the delay is too short.</p>

<p>Overall, there is quite a bit that could be optimized to make sure 
that QGIS remains responsive while the plugin and analysis are running 
as well as other improvements and extensions that could be made. But all
 this would increase the amount of code needed quite a bit and this has 
already been a rather long project to begin with requiring you to read 
and understand a lot of code. As we said before, it is not required to 
understand each line in the code; the crucial points to understand are 
how we are using classes, objects, and inheritance in this project and 
make use of the other techniques and concepts taught in this lesson. 
Reading and understanding other people’s code is one of the main ways to
 become a better programmer and since we are approaching the end of this
 course, this was a good place to practice this a bit and maybe provide 
some inspiration for your term project. However, we certainly don’t 
expect your term project to be nearly as complex as the plugin created 
in this section!</p>
</div></div></div>  </div>
</div>
</div>
    <div class="print-footer">
</div>
    <hr class="print-hr">
          <div class="print-source_url">
        <strong>Source URL:</strong> https://www.e-education.psu.edu/geog489/node/2316      </div>
        <div class="print-links"><p><strong>Links</strong><br>[1] https://www.e-education.psu.edu/geog489/sites/www.e-education.psu.edu.geog489/files/downloads/bustrackanalyzer_complete.zip<br>
[2] 
https://www.e-education.psu.edu/geog489/sites/www.e-education.psu.edu.geog489/files/downloads/bus_track_analyzer_for_qgis_dockwidget_base.zip<br>
</p></div>
    <script type="text/javascript" src="4.12%20Optional:%20Turning%20the%20Bus%20Event%20Analyzer%20into%20a%20QGIS%20Plugin_arquivos/syntaxhighlighter.js"></script>
  

</body></html>